<div class="historia-detalle-container">
  <!-- Header -->
  <header class="detalle-header">
    <div class="header-title">
      <h1 *ngIf="historia">
        <i class="fas fa-file-medical"></i>
        Historia Clínica #{{ historiaId }}
        <span class="estado-badge" [ngClass]="obtenerClaseEstado(historia.Estado)">
          {{ historia.Estado }}
        </span>
      </h1>
      <p *ngIf="historia">
        Paciente: {{ historia.Nombre }} {{ historia.ApellidoPaterno }} {{ historia.ApellidoMaterno }} |
        Fecha: {{ historia.Fecha | date:'dd/MM/yyyy' }}
      </p>
    </div>

    <div class="header-actions">
      <button class="btn-secondary" (click)="volverAlDashboard()">
        <i class="fas fa-arrow-left"></i>
        Volver
      </button>
      <button class="btn-outline" (click)="imprimirHistoria()">
        <i class="fas fa-print"></i>
        Imprimir
      </button>
      <button class="btn-primary" *ngIf="historia && !historia.Archivado && historia.Estado !== 'Finalizado'" (click)="editarHistoria()">
        <i class="fas fa-edit"></i>
        Editar
      </button>
    </div>
  </header>

  <!-- Mensaje de error -->
  <div *ngIf="error" class="error-message">
    <i class="fas fa-exclamation-triangle"></i>
    {{ error }}
  </div>

  <!-- Indicador de carga -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando historia clínica...</p>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!loading && historia" class="detalle-content">
    <!-- Pestañas de navegación -->
    <div class="detalle-tabs">
      <button type="button" [ngClass]="getButtonClass('datos-generales')" (click)="changeTab('datos-generales')">
        <i class="fas fa-info-circle"></i>
        Datos Generales
      </button>
      <button type="button" [ngClass]="getButtonClass('interrogatorio')" (click)="changeTab('interrogatorio')">
        <i class="fas fa-clipboard-list"></i>
        Interrogatorio
      </button>
      <button type="button" [ngClass]="getButtonClass('antecedente-visual')" (click)="changeTab('antecedente-visual')">
        <i class="fas fa-eye"></i>
        Antecedente Visual
      </button>
      <button type="button" [ngClass]="getButtonClass('examen-preliminar')" (click)="changeTab('examen-preliminar')">
        <i class="fas fa-search"></i>
        Examen Preliminar
      </button>
      <button type="button" [ngClass]="getButtonClass('estado-refractivo')" (click)="changeTab('estado-refractivo')">
        <i class="fas fa-glasses"></i>
        Estado Refractivo
      </button>
      <button type="button" [ngClass]="getButtonClass('binocularidad')" (click)="changeTab('binocularidad')">
        <i class="fas fa-binoculars"></i>
        Binocularidad
      </button>
      <button type="button" [ngClass]="getButtonClass('receta')" (click)="changeTab('receta')">
        <i class="fas fa-prescription"></i>
        Receta Final
      </button>
      <button type="button" [ngClass]="getButtonClass('comentarios')" (click)="changeTab('comentarios')">
        <i class="fas fa-comments"></i>
        Comentarios
        <span class="badge" *ngIf="historia.comentarios && historia.comentarios.length > 0">
          {{ historia.comentarios.length }}
        </span>
      </button>
    </div>

    <!-- Contenido de pestañas -->
    <div class="tab-content">
      <!-- Datos generales -->
      <div *ngIf="currentTab === 'datos-generales'" class="tab-pane">
        <section class="info-section">
          <h2>Información General</h2>

          <div class="info-grid">
            <div class="info-item">
              <h3>Fecha de Consulta</h3>
              <p>{{ historia.Fecha | date:'dd/MM/yyyy' }}</p>
            </div>

            <div class="info-item">
              <h3>Consultorio</h3>
              <p>{{ historia.Consultorio }}</p>
            </div>

            <div class="info-item">
              <h3>Semestre</h3>
              <p>{{ historia.Semestre }}</p>
            </div>

            <div class="info-item">
              <h3>Estado</h3>
              <p>
                <span class="estado-badge" [ngClass]="obtenerClaseEstado(historia.Estado)">
                  {{ historia.Estado }}
                </span>

                <span *ngIf="historia.Archivado" class="badge archivado">
                  <i class="fas fa-archive"></i>
                  Archivado
                </span>
              </p>
            </div>

            <div class="info-item">
              <h3>Profesor</h3>
              <p>{{ nombreCompletoProfesor }}</p>
            </div>

            <div class="info-item">
              <h3>Alumno</h3>
              <p>{{ nombreCompletoAlumno }}</p>
            </div>
          </div>
        </section>

        <section class="info-section">
          <h2>Información del Paciente</h2>

          <div class="info-grid">
            <div class="info-item">
              <h3>Nombre Completo</h3>
              <p>{{ historia.Nombre }} {{ historia.ApellidoPaterno }} {{ historia.ApellidoMaterno }}</p>
            </div>

            <div class="info-item">
              <h3>Edad</h3>
              <p>{{ historia.Edad }} años</p>
            </div>

            <div class="info-item">
              <h3>Género</h3>
              <p>{{ historia.GeneroID ? 'Masculino' : 'Femenino' }}</p>
            </div>

            <div class="info-item">
              <h3>Correo Electrónico</h3>
              <p>{{ historia.CorreoElectronico }}</p>
            </div>

            <div class="info-item">
              <h3>Teléfono Celular</h3>
              <p>{{ historia.TelefonoCelular }}</p>
            </div>

            <div class="info-item">
              <h3>Teléfono Fijo</h3>
              <p>{{ historia.Telefono || 'No proporcionado' }}</p>
            </div>

            <div class="info-item">
              <h3>Ocupación</h3>
              <p>{{ historia.Ocupacion || 'No proporcionado' }}</p>
            </div>

            <div class="info-item">
              <h3>Dirección</h3>
              <p>
                {{ historia.DireccionLinea1 || 'No proporcionado' }}
                <span *ngIf="historia.DireccionLinea2">, {{ historia.DireccionLinea2 }}</span>
              </p>
            </div>

            <div class="info-item">
              <h3>Ciudad</h3>
              <p>{{ historia.Ciudad || 'No proporcionado' }}</p>
            </div>

            <div class="info-item">
              <h3>Código Postal</h3>
              <p>{{ historia.CodigoPostal || 'No proporcionado' }}</p>
            </div>

            <div class="info-item">
              <h3>Estado</h3>
              <p>{{ historia.PacienteEstadoID }}</p>
            </div>

            <div class="info-item">
              <h3>País</h3>
              <p>{{ historia.Pais || 'México' }}</p>
            </div>
          </div>
        </section>
      </div>

      <!-- Interrogatorio -->
      <div *ngIf="currentTab === 'interrogatorio'" class="tab-pane">
        <section class="info-section" *ngIf="historia.interrogatorio">
          <h2>Interrogatorio</h2>

          <div class="info-grid-full">
            <div class="info-item">
              <h3>Motivo de Consulta</h3>
              <p>{{ historia.interrogatorio.MotivoConsulta }}</p>
            </div>

            <div class="info-item">
              <h3>Heredo Familiares</h3>
              <p>{{ historia.interrogatorio.HeredoFamiliares }}</p>
            </div>

            <div class="info-item">
              <h3>No Patológicos</h3>
              <p>{{ historia.interrogatorio.NoPatologicos }}</p>
            </div>

            <div class="info-item">
              <h3>Patológicos</h3>
              <p>{{ historia.interrogatorio.Patologicos }}</p>
            </div>

            <div class="info-item">
              <h3>Visuales/Oculares</h3>
              <p>{{ historia.interrogatorio.VisualesOculares }}</p>
            </div>

            <div class="info-item">
              <h3>Padecimiento Actual</h3>
              <p>{{ historia.interrogatorio.PadecimientoActual }}</p>
            </div>

            <div class="info-item">
              <h3>Prediagnóstico</h3>
              <p>{{ historia.interrogatorio.Prediagnostico }}</p>
            </div>
          </div>
        </section>

        <div class="no-data" *ngIf="!historia.interrogatorio">
          <i class="fas fa-clipboard-list"></i>
          <p>No se ha registrado información de interrogatorio para esta historia clínica.</p>
          <button class="btn-primary" *ngIf="!historia.Archivado && historia.Estado !== 'Finalizado'" (click)="editarHistoria()">
            <i class="fas fa-edit"></i>
            Agregar Interrogatorio
          </button>
        </div>
      </div>

      <!-- Antecedente Visual -->
      <div *ngIf="currentTab === 'antecedente-visual'" class="tab-pane">
        <!-- Sección de Agudeza Visual -->
        <section class="info-section" *ngIf="historia.agudezaVisual && historia.agudezaVisual.length > 0">
          <h2>Agudeza Visual</h2>

          <div *ngFor="let agudeza of historia.agudezaVisual" class="agudeza-section">
            <h3>{{ obtenerNombreTipoMedicion(agudeza.TipoMedicion) }}</h3>

            <div class="table-responsive">
              <table class="table-agudeza">
                <thead>
                  <tr>
                    <th></th>
                    <th>OD</th>
                    <th>OI</th>
                    <th>AO</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Para mediciones de lejos -->
                  <tr *ngIf="esMedicionLejos(agudeza.TipoMedicion)">
                    <td>Snellen</td>
                    <td>{{ agudeza.OjoDerechoSnellen || '-' }}</td>
                    <td>{{ agudeza.OjoIzquierdoSnellen || '-' }}</td>
                    <td>{{ agudeza.AmbosOjosSnellen || '-' }}</td>
                  </tr>
                  <tr *ngIf="esMedicionLejos(agudeza.TipoMedicion)">
                    <td>Metros</td>
                    <td>{{ agudeza.OjoDerechoMetros || '-' }}</td>
                    <td>{{ agudeza.OjoIzquierdoMetros || '-' }}</td>
                    <td>{{ agudeza.AmbosOjosMetros || '-' }}</td>
                  </tr>
                  <tr *ngIf="esMedicionLejos(agudeza.TipoMedicion)">
                    <td>MAR</td>
                    <td>{{ agudeza.OjoDerechoMAR || '-' }}</td>
                    <td>{{ agudeza.OjoIzquierdoMAR || '-' }}</td>
                    <td>{{ agudeza.AmbosOjosMAR || '-' }}</td>
                  </tr>

                  <!-- Para mediciones de cerca -->
                  <tr *ngIf="esMedicionCerca(agudeza.TipoMedicion)">
                    <td>M</td>
                    <td>{{ agudeza.OjoDerechoM || '-' }}</td>
                    <td>{{ agudeza.OjoIzquierdoM || '-' }}</td>
                    <td>{{ agudeza.AmbosOjosM || '-' }}</td>
                  </tr>
                  <tr *ngIf="esMedicionCerca(agudeza.TipoMedicion)">
                    <td>Jeager</td>
                    <td>{{ agudeza.OjoDerechoJeager || '-' }}</td>
                    <td>{{ agudeza.OjoIzquierdoJeager || '-' }}</td>
                    <td>{{ agudeza.AmbosOjosJeager || '-' }}</td>
                  </tr>
                  <tr *ngIf="esMedicionCerca(agudeza.TipoMedicion)">
                    <td>Puntos</td>
                    <td>{{ agudeza.OjoDerechoPuntos || '-' }}</td>
                    <td>{{ agudeza.OjoIzquierdoPuntos || '-' }}</td>
                    <td>{{ agudeza.AmbosOjosPuntos || '-' }}</td>
                  </tr>

                  <!-- Para capacidad visual -->
                  <tr *ngIf="agudeza.TipoMedicion === 'CAP_VISUAL'">
                    <td>Capacidad Visual</td>
                    <td>{{ agudeza.CapacidadVisualOD || '-' }}</td>
                    <td>{{ agudeza.CapacidadVisualOI || '-' }}</td>
                    <td>{{ agudeza.CapacidadVisualAO || '-' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div *ngIf="agudeza.TipoMedicion === 'CAP_VISUAL'" class="agudeza-adicional">
              <p><strong>Diámetro (mm):</strong> {{ agudeza.DiametroMM || 'No registrado' }}</p>
            </div>
          </div>
        </section>

        <!-- Sección de Lensometría -->
        <section class="info-section" *ngIf="historia.lensometria">
          <h2>Lensometría</h2>

          <div class="table-responsive">
            <table class="table-lensometria">
              <thead>
                <tr>
                  <th></th>
                  <th>Esfera</th>
                  <th>Cilindro</th>
                  <th>Eje</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>OD</strong></td>
                  <td>{{ historia.lensometria.OjoDerechoEsfera || '-' }}</td>
                  <td>{{ historia.lensometria.OjoDerechoCilindro || '-' }}</td>
                  <td>{{ historia.lensometria.OjoDerechoEje || '-' }}</td>
                </tr>
                <tr>
                  <td><strong>OI</strong></td>
                  <td>{{ historia.lensometria.OjoIzquierdoEsfera || '-' }}</td>
                  <td>{{ historia.lensometria.OjoIzquierdoCilindro || '-' }}</td>
                  <td>{{ historia.lensometria.OjoIzquierdoEje || '-' }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <h3>Tipo de Lente</h3>
              <p>{{ obtenerTipoLente(historia.lensometria.TipoBifocalMultifocalID) }}</p>
            </div>

            <div class="info-item">
              <h3>ADD</h3>
              <p>{{ historia.lensometria.ValorADD || 'No aplicable' }}</p>
            </div>

            <div class="info-item">
              <h3>Distancia/Rango</h3>
              <p>{{ historia.lensometria.DistanciaRango || 'No registrado' }}</p>
            </div>

            <div class="info-item">
              <h3>Centro Óptico</h3>
              <p>{{ historia.lensometria.CentroOptico || 'No registrado' }}</p>
            </div>
          </div>
        </section>

        <!-- Mensaje cuando no hay datos -->
        <div class="no-data" *ngIf="(!historia.agudezaVisual || historia.agudezaVisual.length === 0) && !historia.lensometria">
          <i class="fas fa-eye"></i>
          <p>No se ha registrado información de antecedente visual para esta historia clínica.</p>
          <button class="btn-primary" *ngIf="!historia.Archivado && historia.Estado !== 'Finalizado'" (click)="editarHistoria()">
            <i class="fas fa-edit"></i>
            Agregar Antecedente Visual
          </button>
        </div>
      </div>

      <!-- Examen Preliminar -->
      <div *ngIf="currentTab === 'examen-preliminar'" class="tab-pane">
        <section class="info-section" *ngIf="historia.alineacionOcular">
          <h2>Alineación Ocular</h2>
          <div class="info-grid">
            <div class="info-item">
              <h3>Lejos Horizontal</h3>
              <p>{{ historia.alineacionOcular.LejosHorizontal || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>Lejos Vertical</h3>
              <p>{{ historia.alineacionOcular.LejosVertical || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>Cerca Horizontal</h3>
              <p>{{ historia.alineacionOcular.CercaHorizontal || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>Cerca Vertical</h3>
              <p>{{ historia.alineacionOcular.CercaVertical || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>Método</h3>
              <p>{{ obtenerNombreMetodo(historia.alineacionOcular.MetodoID) }}</p>
            </div>
          </div>
        </section>

        <section class="info-section" *ngIf="historia.motilidad">
          <h2>Motilidad</h2>
          <div class="info-grid">
            <div class="info-item">
              <h3>Versiones</h3>
              <p>{{ historia.motilidad.Versiones || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>Ducciones</h3>
              <p>{{ historia.motilidad.Ducciones || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>Sacádicos</h3>
              <p>{{ historia.motilidad.Sacadicos || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>Persecución</h3>
              <p>{{ historia.motilidad.Persecucion || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>Fijación</h3>
              <p>{{ historia.motilidad.Fijacion || 'No registrado' }}</p>
            </div>
          </div>
        </section>

        <section class="info-section" *ngIf="historia.exploracionFisica">
          <h2>Exploración Física</h2>
          <div class="info-grid">
            <div class="info-item">
              <h3>OD Anexos</h3>
              <p>{{ historia.exploracionFisica.OjoDerechoAnexos || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>OI Anexos</h3>
              <p>{{ historia.exploracionFisica.OjoIzquierdoAnexos || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>OD Segmento Anterior</h3>
              <p>{{ historia.exploracionFisica.OjoDerechoSegmentoAnterior || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>OI Segmento Anterior</h3>
              <p>{{ historia.exploracionFisica.OjoIzquierdoSegmentoAnterior || 'No registrado' }}</p>
            </div>
          </div>
        </section>

        <section class="info-section" *ngIf="historia.viaPupilar">
          <h2>Vía Pupilar</h2>
          <div class="info-grid">
            <div class="info-item">
              <h3>Diámetro OD</h3>
              <p>{{ historia.viaPupilar.OjoDerechoDiametro || 'No registrado' }} mm</p>
            </div>
            <div class="info-item">
              <h3>Diámetro OI</h3>
              <p>{{ historia.viaPupilar.OjoIzquierdoDiametro || 'No registrado' }} mm</p>
            </div>
            <div class="info-item">
              <h3>Reflejos OD</h3>
              <ul class="reflejo-list">
                <li *ngIf="historia.viaPupilar.OjoDerechoFotomotorPresente">Fotomotor Presente</li>
                <li *ngIf="historia.viaPupilar.OjoDerechoConsensualPresente">Consensual Presente</li>
                <li *ngIf="historia.viaPupilar.OjoDerechoAcomodativoPresente">Acomodativo Presente</li>
                <li *ngIf="historia.viaPupilar.OjoDerechoFotomotorAusente">Fotomotor Ausente</li>
                <li *ngIf="historia.viaPupilar.OjoDerechoConsensualAusente">Consensual Ausente</li>
                <li *ngIf="historia.viaPupilar.OjoDerechoAcomodativoAusente">Acomodativo Ausente</li>
                <li *ngIf="!tieneReflejosOD(historia.viaPupilar)">No registrados</li>
              </ul>
            </div>
            <div class="info-item">
              <h3>Reflejos OI</h3>
              <ul class="reflejo-list">
                <li *ngIf="historia.viaPupilar.OjoIzquierdoFotomotorPresente">Fotomotor Presente</li>
                <li *ngIf="historia.viaPupilar.OjoIzquierdoConsensualPresente">Consensual Presente</li>
                <li *ngIf="historia.viaPupilar.OjoIzquierdoAcomodativoPresente">Acomodativo Presente</li>
                <li *ngIf="historia.viaPupilar.OjoIzquierdoFotomotorAusente">Fotomotor Ausente</li>
                <li *ngIf="historia.viaPupilar.OjoIzquierdoConsensualAusente">Consensual Ausente</li>
                <li *ngIf="historia.viaPupilar.OjoIzquierdoAcomodativoAusente">Acomodativo Ausente</li>
                <li *ngIf="!tieneReflejosOI(historia.viaPupilar)">No registrados</li>
              </ul>
            </div>
          </div>
          
          <div class="info-grid">
            <div class="info-item">
              <h3>Características Pupilares</h3>
              <ul class="caracteristicas-list">
                <li *ngIf="historia.viaPupilar.EsIsocoria">Isocoria</li>
                <li *ngIf="historia.viaPupilar.EsAnisocoria">Anisocoria</li>
                <li *ngIf="historia.viaPupilar.RespuestaAcomodacion">Respuesta a Acomodación</li>
                <li *ngIf="historia.viaPupilar.PupilasIguales">Pupilas Iguales</li>
                <li *ngIf="historia.viaPupilar.PupilasRedondas">Pupilas Redondas</li>
                <li *ngIf="historia.viaPupilar.RespuestaLuz">Respuesta a Luz</li>
                <li *ngIf="!tieneCaracteristicasPupilares(historia.viaPupilar)">No registradas</li>
              </ul>
            </div>
            <div class="info-item">
              <h3>DIP</h3>
              <p>{{ historia.viaPupilar.DIP || 'No registrado' }}</p>
            </div>
            <div class="info-item">
              <h3>Dominancia Ocular</h3>
              <p>{{ obtenerDominanciaOcular(historia.viaPupilar.DominanciaOcularID) }}</p>
            </div>
          </div>
        </section>

        <div class="no-data" *ngIf="!historia.alineacionOcular && !historia.motilidad && !historia.exploracionFisica && !historia.viaPupilar">
          <i class="fas fa-search"></i>
          <p>No se ha registrado información del examen preliminar para esta historia clínica.</p>
          <button class="btn-primary" *ngIf="!historia.Archivado && historia.Estado !== 'Finalizado'" (click)="editarHistoria()">
            <i class="fas fa-edit"></i>
            Agregar Examen Preliminar
          </button>
        </div>
      </div>

      <!-- Estado Refractivo -->
<div *ngIf="currentTab === 'estado-refractivo'" class="tab-pane">
  <section class="info-section" *ngIf="historia.estadoRefractivo">
    <h2>Queratometría y Retinoscopía</h2>
    
    <div class="info-grid">
      <div class="info-item">
        <h3>OD Queratometría</h3>
        <p>{{ historia.estadoRefractivo.OjoDerechoQueratometria || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>OI Queratometría</h3>
        <p>{{ historia.estadoRefractivo.OjoIzquierdoQueratometria || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>OD Astigmatismo Corneal</h3>
        <p>{{ historia.estadoRefractivo.OjoDerechoAstigmatismoCorneal || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>OI Astigmatismo Corneal</h3>
        <p>{{ historia.estadoRefractivo.OjoIzquierdoAstigmatismoCorneal || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>OD Regla Javal</h3>
        <p>{{ historia.estadoRefractivo.OjoDerechoAstigmatismoJaval || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>OI Regla Javal</h3>
        <p>{{ historia.estadoRefractivo.OjoIzquierdoAstigmatismoJaval || 'No registrado' }}</p>
      </div>
    </div>
    
    <h3>Retinoscopía</h3>
    <div class="table-responsive">
      <table class="table-lensometria">
        <thead>
          <tr>
            <th></th>
            <th>Esfera</th>
            <th>Cilindro</th>
            <th>Eje</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>OD</strong></td>
            <td>{{ historia.estadoRefractivo.OjoDerechoRetinoscopiaEsfera || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoDerechoRetinosciopiaCilindro || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoDerechoRetinoscopiaEje || '-' }}</td>
          </tr>
          <tr>
            <td><strong>OI</strong></td>
            <td>{{ historia.estadoRefractivo.OjoIzquierdoRetinoscopiaEsfera || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoIzquierdoRetinosciopiaCilindro || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoIzquierdoRetinoscopiaEje || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
  
  <section class="info-section" *ngIf="historia.estadoRefractivo">
    <h2>Subjetivo y Balance Binoculares</h2>
    
    <h3>Subjetivo</h3>
    <div class="table-responsive">
      <table class="table-lensometria">
        <thead>
          <tr>
            <th></th>
            <th>Esfera</th>
            <th>Cilindro</th>
            <th>Eje</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>OD</strong></td>
            <td>{{ historia.estadoRefractivo.OjoDerechoSubjetivoEsfera || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoDerechoSubjetivoCilindro || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoDerechoSubjetivoEje || '-' }}</td>
          </tr>
          <tr>
            <td><strong>OI</strong></td>
            <td>{{ historia.estadoRefractivo.OjoIzquierdoSubjetivoEsfera || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoIzquierdoSubjetivoCilindro || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoIzquierdoSubjetivoEje || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <h3>Balance Binoculares</h3>
    <div class="table-responsive">
      <table class="table-lensometria">
        <thead>
          <tr>
            <th></th>
            <th>Esfera</th>
            <th>Cilindro</th>
            <th>Eje</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>OD</strong></td>
            <td>{{ historia.estadoRefractivo.OjoDerechoBalanceBinocularesEsfera || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoDerechoBalanceBinocularesCilindro || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoDerechoBalanceBinocularesEje || '-' }}</td>
          </tr>
          <tr>
            <td><strong>OI</strong></td>
            <td>{{ historia.estadoRefractivo.OjoIzquierdoBalanceBinocularesEsfera || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoIzquierdoBalanceBinocularesCilindro || '-' }}</td>
            <td>{{ historia.estadoRefractivo.OjoIzquierdoBalanceBinocularesEje || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="info-grid">
      <div class="info-item">
        <h3>OD AV Lejana</h3>
        <p>{{ historia.estadoRefractivo.OjoDerechoAVLejana || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>OI AV Lejana</h3>
        <p>{{ historia.estadoRefractivo.OjoIzquierdoAVLejana || 'No registrado' }}</p>
      </div>
    </div>
  </section>
  
  <section class="info-section" *ngIf="historia.subjetivoCerca">
    <h2>Subjetivo de Cerca</h2>
    
    <div class="table-responsive">
      <table class="table-agudeza">
        <thead>
          <tr>
            <th></th>
            <th>OD</th>
            <th>OI</th>
            <th>AO</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>M</strong></td>
            <td>{{ historia.subjetivoCerca.OjoDerechoM || '-' }}</td>
            <td>{{ historia.subjetivoCerca.OjoIzquierdoM || '-' }}</td>
            <td>{{ historia.subjetivoCerca.AmbosOjosM || '-' }}</td>
          </tr>
          <tr>
            <td><strong>Jaeger</strong></td>
            <td>{{ historia.subjetivoCerca.OjoDerechoJacger || '-' }}</td>
            <td>{{ historia.subjetivoCerca.OjoIzquierdoJacger || '-' }}</td>
            <td>{{ historia.subjetivoCerca.AmbosOjosJacger || '-' }}</td>
          </tr>
          <tr>
            <td><strong>Puntos</strong></td>
            <td>{{ historia.subjetivoCerca.OjoDerechoPuntos || '-' }}</td>
            <td>{{ historia.subjetivoCerca.OjoIzquierdoPuntos || '-' }}</td>
            <td>{{ historia.subjetivoCerca.AmbosOjosPuntos || '-' }}</td>
          </tr>
          <tr>
            <td><strong>Snellen</strong></td>
            <td>{{ historia.subjetivoCerca.OjoDerechoSnellen || '-' }}</td>
            <td>{{ historia.subjetivoCerca.OjoIzquierdoSnellen || '-' }}</td>
            <td>{{ historia.subjetivoCerca.AmbosOjosSnellen || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="info-grid">
      <div class="info-item">
        <h3>Valor ADD</h3>
        <p>{{ historia.subjetivoCerca.ValorADD || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>AV</h3>
        <p>{{ historia.subjetivoCerca.AV || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>Distancia</h3>
        <p>{{ historia.subjetivoCerca.Distancia || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>Rango</h3>
        <p>{{ historia.subjetivoCerca.Rango || 'No registrado' }}</p>
      </div>
    </div>
  </section>
  
  <div class="no-data" *ngIf="!historia.estadoRefractivo && !historia.subjetivoCerca">
    <i class="fas fa-glasses"></i>
    <p>No se ha registrado información de estado refractivo para esta historia clínica.</p>
    <button class="btn-primary" *ngIf="!historia.Archivado && historia.Estado !== 'Finalizado'" (click)="editarHistoria()">
      <i class="fas fa-edit"></i>
      Agregar Estado Refractivo
    </button>
  </div>
</div>

<!-- Sección de Binocularidad -->
<div *ngIf="currentTab === 'binocularidad'" class="tab-pane">
  <!-- Subsección de Binocularidad -->
  <section class="info-section" *ngIf="historia.binocularidad">
    <h2>Binocularidad</h2>
    <div class="info-grid">
      <div class="info-item">
        <h3>PPC</h3>
        <p>{{ historia.binocularidad.PPC || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>ARN</h3>
        <p>{{ historia.binocularidad.ARN || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>ARP</h3>
        <p>{{ historia.binocularidad.ARP || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>Mediciones</h3>
        <ul class="caracteristicas-list">
          <li *ngIf="historia.binocularidad.Donders">Donders</li>
          <li *ngIf="historia.binocularidad.Sheards">Sheards</li>
          <li *ngIf="!historia.binocularidad.Donders && !historia.binocularidad.Sheards">No registrado</li>
        </ul>
      </div>
      <div class="info-item">
        <h3>Hab. Acom. Lente</h3>
        <p>{{ historia.binocularidad.HabAcomLente || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>Hab. Acom. Dificultad</h3>
        <p>{{ historia.binocularidad.HabAcomDificultad || 'No registrado' }}</p>
      </div>
    </div>

    <h3>Amplitud de Acomodación</h3>
    <div class="table-responsive">
      <table class="table-agudeza">
        <thead>
          <tr>
            <th></th>
            <th>cm</th>
            <th>D</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>OD</strong></td>
            <td>{{ historia.binocularidad.OjoDerechoAmpAcomCm || '-' }}</td>
            <td>{{ historia.binocularidad.OjoDerechoAmpAcomD || '-' }}</td>
          </tr>
          <tr>
            <td><strong>OI</strong></td>
            <td>{{ historia.binocularidad.OjoIzquierdoAmpAcomCm || '-' }}</td>
            <td>{{ historia.binocularidad.OjoIzquierdoAmpAcomD || '-' }}</td>
          </tr>
          <tr>
            <td><strong>AO</strong></td>
            <td>{{ historia.binocularidad.AmbosOjosAmpAcomCm || '-' }}</td>
            <td>{{ historia.binocularidad.AmbosOjosAmpAcomD || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Subsección de Forias -->
  <section class="info-section" *ngIf="historia.forias">
    <h2>Forias</h2>
    <div class="info-grid">
      <div class="info-item">
        <h3>Horizontales Lejos</h3>
        <p>{{ historia.forias.HorizontalesLejos || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>Horizontales Cerca</h3>
        <p>{{ historia.forias.HorizontalesCerca || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>Vertical Lejos</h3>
        <p>{{ historia.forias.VerticalLejos || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>Vertical Cerca</h3>
        <p>{{ historia.forias.VerticalCerca || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>Método de Medición</h3>
        <p>{{ obtenerNombreMetodo(historia.forias.MetodoMedicionID) }}</p>
      </div>
      <div class="info-item">
        <h3>CAA</h3>
        <p>{{ historia.forias.CAA || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>CAA Calculada</h3>
        <p>{{ historia.forias.CAACalculada || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>CAA Medida</h3>
        <p>{{ historia.forias.CAAMedida || 'No registrado' }}</p>
      </div>
    </div>
  </section>

  <!-- Subsección de Vergencias -->
  <section class="info-section" *ngIf="historia.vergencias">
    <h2>Vergencias</h2>
    
    <h3>Vergencias Positivas</h3>
    <div class="table-responsive">
      <table class="table-agudeza">
        <thead>
          <tr>
            <th></th>
            <th>Borroso</th>
            <th>Ruptura</th>
            <th>Recuperación</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Lejos</strong></td>
            <td>{{ historia.vergencias.PositivasLejosBorroso || '-' }}</td>
            <td>{{ historia.vergencias.PositivasLejosRuptura || '-' }}</td>
            <td>{{ historia.vergencias.PositivasLejosRecuperacion || '-' }}</td>
          </tr>
          <tr>
            <td><strong>Cerca</strong></td>
            <td>{{ historia.vergencias.PositivasCercaBorroso || '-' }}</td>
            <td>{{ historia.vergencias.PositivasCercaRuptura || '-' }}</td>
            <td>{{ historia.vergencias.PositivasCercaRecuperacion || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h3>Vergencias Negativas</h3>
    <div class="table-responsive">
      <table class="table-agudeza">
        <thead>
          <tr>
            <th></th>
            <th>Borroso</th>
            <th>Ruptura</th>
            <th>Recuperación</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Lejos</strong></td>
            <td>{{ historia.vergencias.NegativasLejosBorroso || '-' }}</td>
            <td>{{ historia.vergencias.NegativasLejosRuptura || '-' }}</td>
            <td>{{ historia.vergencias.NegativasLejosRecuperacion || '-' }}</td>
          </tr>
          <tr>
            <td><strong>Cerca</strong></td>
            <td>{{ historia.vergencias.NegativasCercaBorroso || '-' }}</td>
            <td>{{ historia.vergencias.NegativasCercaRuptura || '-' }}</td>
            <td>{{ historia.vergencias.NegativasCercaRecuperacion || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="form-section-grid">
      <div class="grid-section">
        <h3>Supravergencias</h3>
        <div class="table-responsive">
          <table class="table-agudeza">
            <thead>
              <tr>
                <th></th>
                <th>Ruptura</th>
                <th>Recuperación</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Lejos</strong></td>
                <td>{{ historia.vergencias.SupravergenciasLejosRuptura || '-' }}</td>
                <td>{{ historia.vergencias.SupravergenciasLejosRecuperacion || '-' }}</td>
              </tr>
              <tr>
                <td><strong>Cerca</strong></td>
                <td>{{ historia.vergencias.SupravergenciasCercaRuptura || '-' }}</td>
                <td>{{ historia.vergencias.SupravergenciasCercaRecuperacion || '-' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="grid-section">
        <h3>Infravergencias</h3>
        <div class="table-responsive">
          <table class="table-agudeza">
            <thead>
              <tr>
                <th></th>
                <th>Ruptura</th>
                <th>Recuperación</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Lejos</strong></td>
                <td>{{ historia.vergencias.InfravergenciasLejosRuptura || '-' }}</td>
                <td>{{ historia.vergencias.InfravergenciasLejosRecuperacion || '-' }}</td>
              </tr>
              <tr>
                <td><strong>Cerca</strong></td>
                <td>{{ historia.vergencias.InfravergenciasCercaRuptura || '-' }}</td>
                <td>{{ historia.vergencias.InfravergenciasCercaRecuperacion || '-' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Subsección de Método Gráfico -->
  <!-- <section class="info-section" *ngIf="historia.metodoGrafico">
    <h2>Método Gráfico</h2>
    
    <div class="info-grid">
      <div class="info-item">
        <h3>Integración Binocular</h3>
        <p>{{ historia.metodoGrafico.IntegracionBinocular || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>Tipo de Test</h3>
        <p>{{ obtenerTipoTest(historia.metodoGrafico.TipoID) }}</p>
      </div>
      <div class="info-item">
        <h3>Visión Estereoscópica</h3>
        <p>{{ historia.metodoGrafico.VisionEstereoscopica || 'No registrado' }}</p>
      </div>
      <div class="info-item">
        <h3>Tipo de Visión Estereoscópica</h3>
        <p>{{ obtenerTipoVision(historia.metodoGrafico.TipoVisionID) }}</p>
      </div>
    </div>
    
    <div *ngIf="historia.metodoGrafico.ImagenID" class="metodo-grafico-imagen">
      <h3>Imagen</h3>
      <img [src]="obtenerUrlImagen(historia.metodoGrafico.ImagenID)" alt="Imagen de método gráfico">
    </div>
  </section> -->

  <!-- Mensaje cuando no hay datos -->
  <div class="no-data" *ngIf="!tieneDatosBinocularidad()">
    <i class="fas fa-binoculars"></i>
    <p>No se ha registrado información de binocularidad para esta historia clínica.</p>
    <button class="btn-primary" *ngIf="!historia.Archivado && historia.Estado !== 'Finalizado'" (click)="editarHistoria()">
      <i class="fas fa-edit"></i>
      Agregar Binocularidad
    </button>
  </div>
</div>

      <!-- Diagnóstico -->
      <div *ngIf="currentTab === 'diagnostico'" class="tab-pane">
        <section class="info-section" *ngIf="historia.diagnostico">
          <h2>Diagnóstico</h2>

          <div class="info-grid">
            <div class="info-item">
              <h3>OD Refractivo</h3>
              <p>{{ historia.diagnostico.OjoDerechoRefractivo || 'No registrado' }}</p>
            </div>

            <div class="info-item">
              <h3>OI Refractivo</h3>
              <p>{{ historia.diagnostico.OjoIzquierdoRefractivo || 'No registrado' }}</p>
            </div>

            <div class="info-item">
              <h3>OD Patológico</h3>
              <p>{{ historia.diagnostico.OjoDerechoPatologico || 'No registrado' }}</p>
            </div>

            <div class="info-item">
              <h3>OI Patológico</h3>
              <p>{{ historia.diagnostico.OjoIzquierdoPatologico || 'No registrado' }}</p>
            </div>

            <div class="info-item">
              <h3>Binocular</h3>
              <p>{{ historia.diagnostico.Binocular || 'No registrado' }}</p>
            </div>

            <div class="info-item">
              <h3>Sensorial</h3>
              <p>{{ historia.diagnostico.Sensorial || 'No registrado' }}</p>
            </div>
          </div>
        </section>

        <section class="info-section" *ngIf="historia.planTratamiento">
          <h2>Plan de Tratamiento</h2>
          <div class="info-text">
            {{ historia.planTratamiento.Descripcion || 'No se ha registrado un plan de tratamiento.' }}
          </div>
        </section>

        <section class="info-section" *ngIf="historia.pronostico">
          <h2>Pronóstico</h2>
          <div class="info-text">
            {{ historia.pronostico.Descripcion || 'No se ha registrado un pronóstico.' }}
          </div>
        </section>

        <div class="no-data" *ngIf="!historia.diagnostico && !historia.planTratamiento && !historia.pronostico">
          <i class="fas fa-stethoscope"></i>
          <p>No se ha registrado información de diagnóstico para esta historia clínica.</p>
          <button class="btn-primary" *ngIf="!historia.Archivado && historia.Estado !=='Finalizado'" (click)="editarHistoria()">
            <i class="fas fa-edit"></i>
            Agregar Diagnóstico
          </button>
        </div>
      </div>

      <!-- Receta Final -->
      <div *ngIf="currentTab === 'receta'" class="tab-pane">
        <section class="info-section" *ngIf="historia.recetaFinal">
          <h2>Receta Final</h2>

          <div class="table-responsive">
            <table class="table-receta">
              <thead>
                <tr>
                  <th></th>
                  <th>Esfera</th>
                  <th>Cilindro</th>
                  <th>Eje</th>
                  <th>Prisma</th>
                  <th>Eje Prisma</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>OD</strong></td>
                  <td>{{ historia.recetaFinal.OjoDerechoEsfera || '-' }}</td>
                  <td>{{ historia.recetaFinal.OjoDerechoCilindro || '-' }}</td>
                  <td>{{ historia.recetaFinal.OjoDerechoEje || '-' }}</td>
                  <td>{{ historia.recetaFinal.OjoDerechoPrisma || '-' }}</td>
                  <td>{{ historia.recetaFinal.OjoDerechoEjePrisma || '-' }}</td>
                </tr>
                <tr>
                  <td><strong>OI</strong></td>
                  <td>{{ historia.recetaFinal.OjoIzquierdoEsfera || '-' }}</td>
                  <td>{{ historia.recetaFinal.OjoIzquierdoCilindro || '-' }}</td>
                  <td>{{ historia.recetaFinal.OjoIzquierdoEje || '-' }}</td>
                  <td>{{ historia.recetaFinal.OjoIzquierdoPrisma || '-' }}</td>
                  <td>{{ historia.recetaFinal.OjoIzquierdoEjePrisma || '-' }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <h3>Tratamiento</h3>
              <p>{{ historia.recetaFinal.Tratamiento || 'No registrado' }}</p>
            </div>

            <div class="info-item">
              <h3>Tipo de Lente</h3>
              <p>{{ obtenerTipoLente(historia.recetaFinal.TipoID) }}</p>
            </div>

            <div class="info-item">
              <h3>DIP</h3>
              <p>{{ historia.recetaFinal.DIP || 'No registrado' }}</p>
            </div>

            <div class="info-item">
              <h3>ADD</h3>
              <p>{{ historia.recetaFinal.ValorADD || 'No aplicable' }}</p>
            </div>

            <div class="info-item">
              <h3>Material</h3>
              <p>{{ historia.recetaFinal.Material || 'No registrado' }}</p>
            </div>
          </div>

          <div *ngIf="historia.recetaFinal.Observaciones" class="info-text">
            <h3>Observaciones</h3>
            <p>{{ historia.recetaFinal.Observaciones }}</p>
          </div>
        </section>

        <div class="no-data" *ngIf="!historia.recetaFinal">
          <i class="fas fa-prescription"></i>
          <p>No se ha registrado una receta final para esta historia clínica.</p>
          <button class="btn-primary" *ngIf="!historia.Archivado && historia.Estado !== 'Finalizado'" (click)="editarHistoria()">
            <i class="fas fa-edit"></i>
            Agregar Receta Final
          </button>
        </div>
      </div>

      <!-- Comentarios del Profesor -->
      <div *ngIf="currentTab === 'comentarios'" class="tab-pane">
        <section class="info-section">
          <h2>Comentarios del Profesor</h2>

          <div *ngIf="!historia.comentarios || historia.comentarios.length === 0" class="no-comments">
            <i class="fas fa-comments"></i>
            <p>No hay comentarios del profesor para esta historia clínica.</p>
          </div>

          <div *ngIf="historia.comentarios && historia.comentarios.length > 0" class="comments-list">
            <div *ngFor="let comentario of historia.comentarios" class="comment-item">
              <div class="comment-header">
                <div class="comment-author">
                  <i class="fas fa-chalkboard-teacher"></i>
                  <span>{{ comentario.ProfesorNombre }}</span>
                </div>
                <div class="comment-date">
                  {{ comentario.FechaComentario | date:'dd/MM/yyyy HH:mm' }}
                </div>
              </div>

              <div class="comment-body">
                <p>{{ comentario.Comentario }}</p>
              </div>

              <!-- Respuestas -->
              <div *ngIf="comentario.respuestas && comentario.respuestas.length > 0" class="comment-replies">
                <div *ngFor="let respuesta of comentario.respuestas" class="reply-item">
                  <div class="reply-header">
                    <div class="reply-author">
                      <i class="fas fa-user-graduate"></i>
                      <span>{{ respuesta.AlumnoNombre }}</span>
                    </div>
                    <div class="reply-date">
                      {{ respuesta.FechaRespuesta | date:'dd/MM/yyyy HH:mm' }}
                    </div>
                  </div>

                  <div class="reply-body">
                    <p>{{ respuesta.Respuesta }}</p>
                  </div>
                </div>
              </div>

              <!-- Formulario de respuesta -->
              <div *ngIf="!historia.Archivado && historia.Estado !== 'Finalizado' && (!comentario.respuestas || comentario.respuestas.length === 0)" class="reply-form">
                <textarea placeholder="Escribe tu respuesta al comentario..." #respuesta></textarea>
                <button class="btn-primary" (click)="responderComentario(comentario.ID, respuesta.value)">
                  <i class="fas fa-reply"></i>
                  Responder
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</div>