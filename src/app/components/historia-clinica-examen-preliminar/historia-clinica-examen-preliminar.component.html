<div class="examen-preliminar-container">
  <!-- Error state - idéntico al patrón de otros componentes -->
  <div class="error-container" *ngIf="error && !hideButtons">
    <i class="fas fa-exclamation-triangle"></i>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="guardarExamenPreliminar()">
      <i class="fas fa-sync-alt"></i>
      Reintentar
    </button>
  </div>

  <!-- Success message con fade-out -->
  <div class="success-message fade-out" *ngIf="success && !hideButtons">
    <i class="fas fa-check-circle"></i>
    <p>{{ success }}</p>
  </div>

  <!-- Loading container -->
  <div class="loading-container" *ngIf="loading">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>

  <!-- Formulario -->
  <div *ngIf="!loading" class="form-content">
    <!-- Sección de Alineación Ocular -->
    <div class="form-section">
      <h3 class="section-title">
        <i class="material-icons">visibility</i>
        Alineación Ocular
      </h3>
      <div class="section-divider"></div>

      <form [formGroup]="alineacionForm">
        <div class="table-responsive">
          <table class="table-alineacion">
            <thead>
              <tr>
                <th></th>
                <th>Lejos</th>
                <th>Cerca</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Horizontal</strong></td>
                <td><input type="text" formControlName="lejosHorizontal" class="form-control"></td>
                <td><input type="text" formControlName="cercaHorizontal" class="form-control"></td>
              </tr>
              <tr>
                <td><strong>Vertical</strong></td>
                <td><input type="text" formControlName="lejosVertical" class="form-control"></td>
                <td><input type="text" formControlName="cercaVertical" class="form-control"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="form-group">
          <label for="metodoID">Método de Medición</label>
          <select id="metodoID" formControlName="metodoID" class="form-control">
            <option value="">Seleccionar método</option>
            <option value="1">Pantalleo</option>
            <option value="2">Thorrigton</option>
            <option value="3">Maddox</option>
            <option value="4">Von Graeffe</option>
          </select>
        </div>
      </form>
    </div>

    <!-- Sección de Motilidad -->
    <div class="form-section">
      <h3 class="section-title">
        <i class="material-icons">360</i>
        Motilidad
      </h3>
      <div class="section-divider"></div>

      <form [formGroup]="motilidadForm">
        <div class="table-responsive">
          <table class="table-motilidad">
            <thead>
              <tr>
                <th>Versiones</th>
                <th>Ducciones</th>
                <th>Sacádicos</th>
                <th>Persecución</th>
                <th>Fijación</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="text" formControlName="versiones" class="form-control"></td>
                <td><input type="text" formControlName="ducciones" class="form-control"></td>
                <td><input type="text" formControlName="sacadicos" class="form-control"></td>
                <td><input type="text" formControlName="persecucion" class="form-control"></td>
                <td><input type="text" formControlName="fijacion" class="form-control"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </form>
    </div>

    <!-- Sección de Exploración Física -->
    <div class="form-section">
      <h3 class="section-title">
        <i class="material-icons">medical_services</i>
        Exploración Física
      </h3>
      <div class="section-divider"></div>

      <form [formGroup]="exploracionForm">
        <div class="form-row">
          <div class="form-group">
            <label for="ojoDerechoAnexos">OD Anexos</label>
            <textarea
              #ojoDerechoAnexosRef
              id="ojoDerechoAnexos"
              formControlName="ojoDerechoAnexos"
              class="form-control"
              (input)="autoResize(ojoDerechoAnexosRef)"
              (ngModelChange)="autoResize(ojoDerechoAnexosRef)">
            </textarea>
          </div>
          <div class="form-group">
            <label for="ojoIzquierdoAnexos">OI Anexos</label>
            <textarea
              #ojoIzquierdoAnexosRef
              id="ojoIzquierdoAnexos"
              formControlName="ojoIzquierdoAnexos"
              class="form-control"
              (input)="autoResize(ojoIzquierdoAnexosRef)"
              (ngModelChange)="autoResize(ojoIzquierdoAnexosRef)">
            </textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="ojoDerechoSegmentoAnterior">OD Segmento Anterior</label>
            <textarea
              #ojoDerechoSegmentoAnteriorRef
              id="ojoDerechoSegmentoAnterior"
              formControlName="ojoDerechoSegmentoAnterior"
              class="form-control"
              (input)="autoResize(ojoDerechoSegmentoAnteriorRef)"
              (ngModelChange)="autoResize(ojoDerechoSegmentoAnteriorRef)">
            </textarea>
          </div>
          <div class="form-group">
            <label for="ojoIzquierdoSegmentoAnterior">OI Segmento Anterior</label>
            <textarea
              #ojoIzquierdoSegmentoAnteriorRef
              id="ojoIzquierdoSegmentoAnterior"
              formControlName="ojoIzquierdoSegmentoAnterior"
              class="form-control"
              (input)="autoResize(ojoIzquierdoSegmentoAnteriorRef)"
              (ngModelChange)="autoResize(ojoIzquierdoSegmentoAnteriorRef)">
            </textarea>
          </div>
        </div>
      </form>
    </div>

    <!-- Sección de Vía Pupilar -->
    <div class="form-section">
      <h3 class="section-title">
        <i class="material-icons">remove_red_eye</i>
        Vía Pupilar
      </h3>
      <div class="section-divider"></div>

      <form [formGroup]="viaPupilarForm">
        <div class="form-row">
          <div class="form-group">
            <label for="ojoDerechoDiametro">Diámetro OD (mm)</label>
            <input type="number" id="ojoDerechoDiametro" formControlName="ojoDerechoDiametro" class="form-control" step="0.1" min="0" max="10">
          </div>
          <div class="form-group">
            <label for="ojoIzquierdoDiametro">Diámetro OI (mm)</label>
            <input type="number" id="ojoIzquierdoDiametro" formControlName="ojoIzquierdoDiametro" class="form-control" step="0.1" min="0" max="10">
          </div>
        </div>

        <div class="form-row reflejos-container">
          <div class="form-group">
            <h4 class="subsection-title">Reflejos Pupilares OD</h4>
            <div class="checkbox-grid">
              <div class="checkbox-item">
                <input type="checkbox" id="ojoDerechoFotomotorPresente" formControlName="ojoDerechoFotomotorPresente" class="checkbox-input">
                <label for="ojoDerechoFotomotorPresente" class="checkbox-label">Fotomotor Presente</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="ojoDerechoConsensualPresente" formControlName="ojoDerechoConsensualPresente" class="checkbox-input">
                <label for="ojoDerechoConsensualPresente" class="checkbox-label">Consensual Presente</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="ojoDerechoAcomodativoPresente" formControlName="ojoDerechoAcomodativoPresente" class="checkbox-input">
                <label for="ojoDerechoAcomodativoPresente" class="checkbox-label">Acomodativo Presente</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="ojoDerechoFotomotorAusente" formControlName="ojoDerechoFotomotorAusente" class="checkbox-input">
                <label for="ojoDerechoFotomotorAusente" class="checkbox-label">Fotomotor Ausente</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="ojoDerechoConsensualAusente" formControlName="ojoDerechoConsensualAusente" class="checkbox-input">
                <label for="ojoDerechoConsensualAusente" class="checkbox-label">Consensual Ausente</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="ojoDerechoAcomodativoAusente" formControlName="ojoDerechoAcomodativoAusente" class="checkbox-input">
                <label for="ojoDerechoAcomodativoAusente" class="checkbox-label">Acomodativo Ausente</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <h4 class="subsection-title">Reflejos Pupilares OI</h4>
            <div class="checkbox-grid">
              <div class="checkbox-item">
                <input type="checkbox" id="ojoIzquierdoFotomotorPresente" formControlName="ojoIzquierdoFotomotorPresente" class="checkbox-input">
                <label for="ojoIzquierdoFotomotorPresente" class="checkbox-label">Fotomotor Presente</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="ojoIzquierdoConsensualPresente" formControlName="ojoIzquierdoConsensualPresente" class="checkbox-input">
                <label for="ojoIzquierdoConsensualPresente" class="checkbox-label">Consensual Presente</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="ojoIzquierdoAcomodativoPresente" formControlName="ojoIzquierdoAcomodativoPresente" class="checkbox-input">
                <label for="ojoIzquierdoAcomodativoPresente" class="checkbox-label">Acomodativo Presente</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="ojoIzquierdoFotomotorAusente" formControlName="ojoIzquierdoFotomotorAusente" class="checkbox-input">
                <label for="ojoIzquierdoFotomotorAusente" class="checkbox-label">Fotomotor Ausente</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="ojoIzquierdoConsensualAusente" formControlName="ojoIzquierdoConsensualAusente" class="checkbox-input">
                <label for="ojoIzquierdoConsensualAusente" class="checkbox-label">Consensual Ausente</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="ojoIzquierdoAcomodativoAusente" formControlName="ojoIzquierdoAcomodativoAusente" class="checkbox-input">
                <label for="ojoIzquierdoAcomodativoAusente" class="checkbox-label">Acomodativo Ausente</label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <h4 class="subsection-title">Características de las Pupilas</h4>
          <div class="checkbox-grid-horizontal">
            <div class="checkbox-item">
              <input type="checkbox" id="esIsocoria" formControlName="esIsocoria" class="checkbox-input">
              <label for="esIsocoria" class="checkbox-label">Isocoria</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="esAnisocoria" formControlName="esAnisocoria" class="checkbox-input">
              <label for="esAnisocoria" class="checkbox-label">Anisocoria</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="respuestaAcomodacion" formControlName="respuestaAcomodacion" class="checkbox-input">
              <label for="respuestaAcomodacion" class="checkbox-label">Respuesta a Acomodación</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="pupilasIguales" formControlName="pupilasIguales" class="checkbox-input">
              <label for="pupilasIguales" class="checkbox-label">Pupilas Iguales</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="pupilasRedondas" formControlName="pupilasRedondas" class="checkbox-input">
              <label for="pupilasRedondas" class="checkbox-label">Pupilas Redondas</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="respuestaLuz" formControlName="respuestaLuz" class="checkbox-input">
              <label for="respuestaLuz" class="checkbox-label">Respuesta a Luz</label>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="dip">DIP (mm)</label>
            <input type="text" id="dip" formControlName="dip" class="form-control">
          </div>
          <div class="form-group">
            <label for="dominanciaOcularID">Dominancia Ocular</label>
            <select id="dominanciaOcularID" formControlName="dominanciaOcularID" class="form-control">
              <option value="">Seleccionar dominancia</option>
              <option value="29">OD</option>
              <option value="30">OI</option>
            </select>
          </div>
        </div>
      </form>
    </div>

    <!-- Botones de acción - Solo se muestran si hideButtons es false -->
    <div class="form-actions" *ngIf="!hideButtons">
      <button type="button" class="btn-secondary" (click)="cancelar()">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button type="button" class="btn-primary" [disabled]="submitting" (click)="guardarExamenPreliminar()">
        <i class="fas fa-save"></i>
        <span *ngIf="!submitting">Guardar Examen Preliminar</span>
        <span *ngIf="submitting">Guardando...</span>
      </button>
    </div>
  </div>
</div>