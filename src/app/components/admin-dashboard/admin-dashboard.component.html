<div class="dashboard-container" (click)="cerrarMenu()">
  <!-- Título -->
  <h1 class="dashboard-title">Panel de Administración</h1>

  <!-- Mensaje de error -->
  <div class="error-container" *ngIf="error">
    <i class="fas fa-exclamation-circle"></i>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="cargarDatos()">
      <i class="fas fa-sync-alt"></i> Reintentar
    </button>
  </div>

  <!-- Estadísticas - Ocultar cuando hay un error -->
  <div class="estadisticas-grid" *ngIf="!error && estadisticas">
    <!-- Total de historias -->
    <div class="stat-card">
      <div class="stat-icon total">
        <i class="fas fa-file-medical"></i>
      </div>
      <div class="stat-info">
        <h3>{{ estadisticas.total }}</h3>
        <p>Total de historias</p>
      </div>
    </div>

    <!-- Total de alumnos -->
    <div class="stat-card">
      <div class="stat-icon alumnos">
        <i class="fas fa-user-graduate"></i>
      </div>
      <div class="stat-info">
        <h3>{{ estadisticas.totalAlumnos }}</h3>
        <p>Alumnos activos</p>
      </div>
    </div>

    <!-- Total de profesores -->
    <div class="stat-card">
      <div class="stat-icon profesores">
        <i class="fas fa-chalkboard-teacher"></i>
      </div>
      <div class="stat-info">
        <h3>{{ estadisticas.totalProfesores }}</h3>
        <p>Profesores activos</p>
      </div>
    </div>

    <!-- Total de materias -->
    <div class="stat-card">
      <div class="stat-icon materias">
        <i class="fas fa-book"></i>
      </div>
      <div class="stat-info">
        <h3>{{ estadisticas.totalMaterias }}</h3>
        <p>Materias activas</p>
      </div>
    </div>

    <!-- Historias archivadas -->
    <div class="stat-card clickable" (click)="aplicarFiltroEstado('archivadas')" *ngIf="estadisticas.archivadas > 0">
      <div class="stat-icon archivadas">
        <i class="fas fa-archive"></i>
      </div>
      <div class="stat-info">
        <h3>{{ estadisticas.archivadas }}</h3>
        <p>Historias archivadas</p>
      </div>
    </div>

    <!-- Estados dinámicos -->
    <div class="stat-card clickable"
         *ngFor="let estado of obtenerEstadosConValores()"
         (click)="aplicarFiltroEstado(estado.estado)">
      <div class="stat-icon" [ngClass]="estado.estado.toLowerCase().replace(' ', '-')">
        <i class="fas"
           [ngClass]="{
             'fa-plus-circle': estado.estado === 'Nuevo',
             'fa-check-circle': estado.estado === 'Corregido',
             'fa-spinner': estado.estado === 'En proceso',
             'fa-eye': estado.estado === 'Revisión',
             'fa-edit': estado.estado === 'Corrección',
             'fa-flag-checkered': estado.estado === 'Finalizado'
           }"></i>
      </div>
      <div class="stat-info">
        <h3>{{ estado.cantidad }}</h3>
        <p>{{ estado.estado }}</p>
      </div>
    </div>
  </div>

  <!-- Filtros de materia -->
  <div class="materias-section" *ngIf="!error">
    <h2>Materias</h2>

    <div class="materias-container">
      <div class="materia-card"
           [class.active]="materiaSeleccionadaId === null && filtroMateriaArchivada === null"
           (click)="aplicarFiltroMateria(null)">
        <div class="materia-info">
          <h3>Todas las materias</h3>
          <p class="materia-periodo">Todos los periodos</p>
        </div>
        <div class="materia-count">
          <span class="count-badge">{{ estadisticasPorMateria.get(null)?.total || 0 }}</span>
        </div>
      </div>

      <div class="materia-card"
           *ngFor="let materia of materias"
           [class.active]="materiaSeleccionadaId === materia.ID"
           (click)="aplicarFiltroMateria(materia.ID)">
        <div class="materia-info">
          <h3>{{ materia.NombreMateria }}</h3>
          <p class="materia-profesor">
            <i class="fas fa-user"></i> {{ materia.NombreProfesor }} ({{ materia.NumeroEmpleado }})
          </p>
          <p class="materia-periodo">{{ materia.PeriodoEscolar }}</p>
        </div>
        <div class="materia-count">
          <span class="count-badge">{{ historiasPorMateria.get(materia.MateriaProfesorID) || 0 }}</span>
        </div>
      </div>
    </div>

    <button class="btn-toggle-historicas" (click)="toggleMateriasHistoricas()">
      <i class="fas" [ngClass]="mostrarMateriasHistoricas ? 'fa-eye-slash' : 'fa-eye'"></i>
      {{ mostrarMateriasHistoricas ? 'Ocultar' : 'Mostrar' }} materias históricas
    </button>
  </div>

  <!-- Sección de historias -->
  <div class="historias-section" *ngIf="!error">
    <h2 class="section-title">
      Aquí puedes ver todas las historias clínicas del sistema
    </h2>
  </div>

  <!-- Filtros -->
  <div class="filtros-container" *ngIf="!error">
    <div class="filtro">
      <label for="filtroEstado">Filtrar por estado:</label>
      <select
        id="filtroEstado"
        [(ngModel)]="filtroEstado"
        (change)="aplicarFiltroEstado(filtroEstado)">
        <option value="todos">Todos los estados</option>
        <option value="Nuevo">Nuevo</option>
        <option value="Corregido">Corregido</option>
        <option value="En proceso">En proceso</option>
        <option value="Revisión">Revisión</option>
        <option value="Corrección">Corrección</option>
        <option value="Finalizado">Finalizado</option>
        <option value="archivadas">Archivadas</option>
      </select>
    </div>

    <div class="filtro">
      <label for="ordenamiento">Ordenar por:</label>
      <select
        id="ordenamiento"
        [(ngModel)]="ordenamiento"
        (change)="aplicarOrdenamiento()">
        <option value="recientes">Fecha (más recientes primero)</option>
        <option value="antiguas">Fecha (más antiguas primero)</option>
        <option value="alfabetico-asc">Nombre (A-Z)</option>
        <option value="alfabetico-desc">Nombre (Z-A)</option>
        <option value="edad-asc">Edad (menor a mayor)</option>
        <option value="edad-desc">Edad (mayor a menor)</option>
        <option value="semestre-reciente">Semestre (más reciente primero)</option>
        <option value="semestre-antiguo">Semestre (más antiguo primero)</option>
      </select>
    </div>

    <div class="filtro">
      <label for="filtroProfesor">Buscar profesor:</label>
      <div class="input-with-icon">
        <i class="fas fa-chalkboard-teacher"></i>
        <input
          type="text"
          id="filtroProfesor"
          [(ngModel)]="filtroProfesor"
          placeholder="Nombre o Número de Empleado"
          (ngModelChange)="onFiltroProfesorChange()"
        >
      </div>
    </div>

    <div class="filtro">
      <label for="filtroAlumno">Buscar alumno:</label>
      <div class="input-with-icon">
        <i class="fas fa-user-graduate"></i>
        <input
          type="text"
          id="filtroAlumno"
          [(ngModel)]="filtroAlumno"
          placeholder="Nombre o Boleta"
          (ngModelChange)="onFiltroAlumnoChange()"
        >
      </div>
    </div>

    <div class="filtro">
      <label for="filtroPaciente">Buscar paciente:</label>
      <div class="input-with-icon">
        <i class="fas fa-search"></i>
        <input
          type="text"
          id="filtroPaciente"
          [(ngModel)]="filtroPaciente"
          placeholder="Nombre, CURP o ID SiSeCo"
          (ngModelChange)="onFiltroPacienteChange()"
        >
      </div>
    </div>
  </div>

  <!-- Tabla de historias clínicas -->
  <div class="tabla-container" *ngIf="!error">
    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Cargando historias clínicas...</p>
    </div>

    <div class="empty-container" *ngIf="!loading && !error && filtrarHistorias().length === 0">
      <i class="fas fa-inbox"></i>
      <p>No se encontraron historias clínicas con los filtros aplicados.</p>
    </div>

    <div class="tabla-scroll-container" *ngIf="!loading && filtrarHistorias().length > 0">
      <table class="tabla-historias">
        <thead>
          <tr>
            <th>Paciente</th>
            <th>Edad</th>
            <th>Alumno</th>
            <th>Profesor</th>
            <th>Materia</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Comentarios</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let historia of obtenerHistoriasPaginadas()">
            <td class="paciente-cell">
              <div class="paciente-info">
                <strong>{{ historia.Nombre }} {{ historia.ApellidoPaterno }} {{ historia.ApellidoMaterno }}</strong>
                <span class="paciente-detalles">
                  <i class="fas fa-id-card"></i> {{ historia.CURP }}
                </span>
                <span class="paciente-detalles" *ngIf="historia.IDSiSeCo">
                  <i class="fas fa-hashtag"></i> {{ historia.IDSiSeCo }}
                </span>
              </div>
            </td>
            <td class="edad-cell">
              <span *ngIf="calcularEdad(historia.FechaNacimiento) !== null">
                {{ calcularEdad(historia.FechaNacimiento) }} años
              </span>
              <span *ngIf="calcularEdad(historia.FechaNacimiento) === null" class="no-data">
                N/A
              </span>
            </td>
            <td class="alumno-cell">
              <div class="alumno-info">
                <strong>{{ historia.NombreAlumno }}</strong>
                <span class="alumno-detalles">
                  <i class="fas fa-id-badge"></i> {{ historia.NumeroBoleta }}
                </span>
                <span class="alumno-detalles">
                  <i class="fas fa-graduation-cap"></i> {{ historia.SemestreActual }}° Semestre
                </span>
              </div>
            </td>
            <td class="profesor-cell">
              <div class="profesor-info">
                <strong>{{ historia.NombreProfesor }}</strong>
                <span class="profesor-detalles">
                  <i class="fas fa-id-badge"></i> {{ historia.NumeroEmpleado }}
                </span>
              </div>
            </td>
            <td class="materia-cell">
              <div class="materia-info-table">
                <strong>{{ historia.NombreMateria }}</strong>
                <span class="materia-detalles">{{ historia.PeriodoEscolar }}</span>
              </div>
            </td>
            <td>
              <span class="badge"
                    [ngClass]="{
                      'badge-nuevo': historia.Estado === 'Nuevo',
                      'badge-corregido': historia.Estado === 'Corregido',
                      'badge-proceso': historia.Estado === 'En proceso',
                      'badge-revision': historia.Estado === 'Revisión',
                      'badge-correccion': historia.Estado === 'Corrección',
                      'badge-finalizado': historia.Estado === 'Finalizado'
                    }">
                {{ historia.Estado }}
              </span>
            </td>
            <td>{{ historia.FechaCreacion | date:'dd/MM/yyyy' }}</td>
            <td class="comentarios-cell">
              <span class="comentarios-badge" *ngIf="historia.TotalComentarios > 0">
                <i class="fas fa-comments"></i> {{ historia.TotalComentarios }}
              </span>
              <span *ngIf="historia.TotalComentarios === 0" class="no-comentarios">
                <i class="fas fa-comment-slash"></i> 0
              </span>
            </td>
            <td class="acciones-cell">
              <div class="acciones-buttons">
                <button class="btn-icon btn-ver"
                        (click)="verHistoria(historia.ID)"
                        title="Ver historia clínica">
                  <i class="fas fa-eye"></i>
                </button>
                <div class="menu-container">
                  <button class="btn-icon btn-menu"
                          (click)="toggleMenu(historia.ID, $event)"
                          title="Más acciones">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" *ngIf="menuAbiertoId === historia.ID">
                    <button (click)="editarHistoria(historia.ID, $event)">
                      <i class="fas fa-edit"></i> Editar
                    </button>
                    <button (click)="verComentarios(historia.ID, $event)">
                      <i class="fas fa-comments"></i> Comentarios
                    </button>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-submenu">
                      <span><i class="fas fa-flag"></i> Cambiar estado</span>
                      <div class="submenu-content">
                        <button (click)="cambiarEstado(historia.ID, 'Nuevo', $event)">Nuevo</button>
                        <button (click)="cambiarEstado(historia.ID, 'Corregido', $event)">Corregido</button>
                        <button (click)="cambiarEstado(historia.ID, 'En proceso', $event)">En proceso</button>
                        <button (click)="cambiarEstado(historia.ID, 'Revisión', $event)">Revisión</button>
                        <button (click)="cambiarEstado(historia.ID, 'Corrección', $event)">Corrección</button>
                        <button (click)="cambiarEstado(historia.ID, 'Finalizado', $event)">Finalizado</button>
                      </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <button (click)="archivarHistoria(historia.ID, $event)" *ngIf="!historia.Archivado">
                      <i class="fas fa-archive"></i> Archivar
                    </button>
                    <button (click)="archivarHistoria(historia.ID, $event)" *ngIf="historia.Archivado">
                      <i class="fas fa-box-open"></i> Desarchivar
                    </button>
                    <button (click)="eliminarHistoria(historia.ID, $event)" class="delete-option">
                      <i class="fas fa-trash"></i> Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="paginacion-container" *ngIf="!loading && filtrarHistorias().length > 0">
      <div class="paginacion-info">
        <label for="registrosPorPagina">Mostrar:</label>
        <select id="registrosPorPagina" [(ngModel)]="registrosPorPagina" (change)="cambiarRegistrosPorPagina()">
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
        </select>
        <span>registros por página</span>
      </div>

      <div class="paginacion-controles">
        <button
          class="btn-pagina"
          [disabled]="paginaActual === 1"
          (click)="cambiarPagina(1)">
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button
          class="btn-pagina"
          [disabled]="paginaActual === 1"
          (click)="cambiarPagina(paginaActual - 1)">
          <i class="fas fa-angle-left"></i>
        </button>

        <span class="pagina-actual">
          Página {{ paginaActual }} de {{ totalPaginas }}
        </span>

        <button
          class="btn-pagina"
          [disabled]="paginaActual === totalPaginas"
          (click)="cambiarPagina(paginaActual + 1)">
          <i class="fas fa-angle-right"></i>
        </button>
        <button
          class="btn-pagina"
          [disabled]="paginaActual === totalPaginas"
          (click)="cambiarPagina(totalPaginas)">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </div>

      <div class="paginacion-total">
        <span>Total: {{ filtrarHistorias().length }} historias</span>
      </div>
    </div>
  </div>
</div>